# Implementation Plan: Gemini Live API Session Management

- [x] 1. **Modify `BaseSessionManager` to Handle Session State**
  - [x] 1.1. Add `currentHandle`, `isConnected`, and `lastMessageTimestamp` properties to the `BaseSessionManager` class.
    - Ref: Design section "Data Models"
- [x] 2. **Update `initSession` for Resumption**
  - [x] 2.1. Modify the `initSession` method in `BaseSessionManager` to accept an optional `resumptionHandle` parameter.
    - Ref: Design section "Components and Interfaces"
- [x] 3. **Implement Session Resumption Logic**
  - [x] 3.1. Update the `onmessage` callback in `getCallbacks()` to parse `sessionResumptionUpdate` messages and store the `newHandle`.
    - Ref: Requirement 2.1.1
- [x] 4. **Implement Graceful Reconnection**
  - [x] 4.1. Create a new `reconnectSession` method in `BaseSessionManager` to handle the logic of reconnecting with the stored `currentHandle`.
    - Ref: Design section "Components and Interfaces"
  - [x] 4.2. Update the `onmessage` callback in `getCallbacks()` to detect `goAway` messages and trigger the `reconnectSession` method.
    - Ref: Requirement 2.2.1
- [x] 5. **Implement Error Handling**
  - [x] 5.1. Add logic to `initSession` to handle invalid/expired token errors by clearing the handle and starting a new session.
    - Ref: Design section "Error Handling"
  - [x] 5.2. Implement an exponential backoff strategy in `reconnectSession` for network failures.
    - Ref: Design section "Error Handling"
- [ ] 6. **Add Unit Tests** (DEFERRED)
  - [ ] 6.1. Create unit tests for the modified `initSession` method. (DEFERRED)
  - [ ] 6.2. Create unit tests for the new `reconnectSession` method. (DEFERRED)
  - [ ] 6.3. Create unit tests for the `onmessage` callback to verify parsing of `sessionResumptionUpdate` and `goAway` messages. (DEFERRED)
- [ ] 7. **Implement Fallback Context Injection**
  - [ ] 7.1. Implement the `handleFallback` method in `BaseSessionManager`.
    - This method should accept a `transcript` and use the `SummarizationService` to get a summary.
    - It should then combine the summary with the last 4 turns of the conversation.
    - Ref: Requirement 2.3.1, 2.3.2
  - [ ] 7.2. Integrate `handleFallback` into the application logic where a model fallback is detected.
    - Ref: Design section "Data Flow"
- [ ] 8. **Add Unit Tests for Fallback Logic** (DEFERRED)
    - [ ] 8.1. Create unit tests for the `handleFallback` method. (DEFERRED)
- [ ] 9. **Add End-to-End Tests** (DEFERRED)
    - [ ] 9.1. Create E2E tests to simulate a session with a fallback and verify context injection. (DEFERRED)